
# 9장. AI 로직 & 점수 산정 구조 (정본 기준)

## 9.1 장 AI 로직 & 데이터 구조 (사진→말씀)

### 9.1.1 목적

- 사진→말씀 추천의 **엔드투엔드 AI 파이프라인** 구조 정리
    
- 각 단계에서 사용하는 **데이터 구조(스키마)** 정의
    
- **성능·품질·안전 기준** 및 **예외 처리·폴백** 원칙 명시
    
- 향후 AI/데이터 팀이 참고할 **단일 기준 문서(데이터북 & 로직 스펙)** 역할
    

### 9.1.2 범위

- 범위에 포함
    
    - **사진 지각→상징→주제→검색→재랭킹→가이드라인→최종 1–2절** 전 과정
        
    - **데이터 엔티티(이벤트·구절·매핑·기록)** 스키마
        
    - **데이터북(24 주제, 120 라벨, 매핑 매트릭스)** 구조
        
    - 모델 품질 기준, 예외 처리, 오프라인팩 구조
        
- 범위에서 제외
    
    - 앱/백엔드 인프라 상세는 **10장(플랫폼·인프라)**에서 다룸
        
    - 운영/비용/QA 조직은 **11장, 12장**에서 다룸
        

---

## 9.2 한 줄 요약

> 사용자의 사진을 **지각(피사체·장면·텍스트·컨텍스트)** 한 뒤,  
> 이를 **상징→주제**로 바꾸고, **벡터 검색 + 재랭킹 + 가이드라인 엔진**을 거쳐  
> **1–2절**과 **설명 카드**를 선택하는 **모듈형 AI 파이프라인**이며,  
> 모든 로직은 **데이터북(24 주제·120 라벨·매핑 매트릭스)**에 의해 통제된다.

---


## 9.3 점수 파이프라인 개요 (v9.1 v1.1)

본 프로젝트의 절(Verse) 분류 및 우선순위 산정은 다음의 3단계 파이프라인으로 구성됩니다.

1) **S1~S4** 신호 추출  
2) 가중합(**score_total**) 계산  
3) 보너스 적용 후 **priority_score** 산출  

본 절은 “기획 의도”가 아니라 **현재 코드에서 실제로 동작하는 로직**만 기술합니다.

## 9.4 S1~S4 신호 정의 및 가중치 적용

### 9.4.1 S1~S4 신호 체계

각 절은 다음 네 가지 축(**Signal**)으로 평가됩니다.

|구분|코드상 명칭|의미|
|---|---|---|
|S1|Object / Scene Anchors|사물·장면·상징 기반 키워드|
|S2|Emotion Anchors|감정·정서 표현|
|S3|Action Anchors|행위·명령·동작|
|S4|Theology Anchors|교리·신학 개념|

각 S값은 **키워드 매칭 히트 수 × 앵커 가중치** 누적으로 계산됩니다.

### 9.4.2 weights 시트 기반 가중치 (비율형)

**weights** 시트에는 S1~S4의 비율형 가중치가 정의되어 있습니다.

|key|의미|현재 적용 상태|
|---|---|---|
|w1|S1 가중치|✅ 사용됨|
|w2|S2 가중치|✅ 사용됨|
|w3|S3 가중치|✅ 사용됨|
|w4|S4 가중치|✅ 사용됨|
|secondary_ratio|보조 후보 제어|❌ 현재 코드 미사용|
|primary_margin|1위 확정 마진|❌ 현재 코드 미사용|

현재 운영 기준 예시: `w1=0.4, w2=0.2, w3=0.2, w4=0.2`  
→ 합계 1.0의 **비율형(weight ratio)** 설계

### 9.4.3 score_total 계산식 (현재 코드 기준)

`score_total = (w1 × S1) + (w2 × S2) + (w3 × S3) + (w4 × S4)`

- **S1~S4**는 독립적으로 계산된 후 가중합됩니다.  
- **score_total**은 정규화 이전의 기본 점수(**base score**) 역할을 합니다.

## 9.5 토픽 선정 로직 (Primary / Secondary)

### 9.5.1 토픽 점수 산정 방식
1) 각 토픽(**topic**)은 S1~S4에서 히트된 점수를 누적하여 보유합니다.  
2) 모든 토픽을 점수 기준으로 내림차순 정렬합니다.

### 9.5.2 결과 필드 구성 (현재 코드 기준)

|필드명|의미|
|---|---|
|topic_primary|점수 1위 토픽|
|topic_secondary_1|점수 2위 토픽|
|topic_secondary_2|점수 3위 토픽|
|topic_secondary_3|점수 4위 토픽|

**주의(중요)**  
현재 코드에는 아래 로직이 존재하지 않습니다.

- Top1–Top2 점수 차이에 따른 병기 여부 판단  
- **secondary_ratio / primary_margin** 기반 조건 분기  

즉, **항상 Top1~Top4가 고정 출력**됩니다.

## 9.6 우선순위 점수(priority_score) 계산

### 9.6.1 priority_rules 시트 구조

**priority_rules** 시트에는 다음 키들이 정의되어 있습니다.

|key|의미|현재 코드 적용 여부|
|---|---|---|
|bonus_anchor|앵커 보너스|✅ 적용|
|bonus_gospel|복음서 보너스|❌ 미적용|
|bonus_wcf|추가 보너스|❌ 미적용|
|normalize_divisor|정규화 분모|✅ 적용|

### 9.6.2 priority_score 계산식 (현재 코드 기준)

`bonus = (S1 > 0) ? bonus_anchor : 0`  

`priority_score = (score_total + bonus) / normalize_divisor`

- 보너스 조건은 **S1 히트 여부**만 사용합니다.  
- 복음서 여부, 예수 직접 발화 여부 등은 **현재 코드에 반영되지 않습니다.**  
- `normalize_divisor=1`이면 정규화 효과는 없습니다.

## 9.7 현재 설계의 해석 및 한계 (정본 명시)

- **weights / priority_rules**는 정책 선언용 파라미터 집합이지만, 실제 적용 여부는 **코드**에 의해 제한됩니다.
- 현재 운영 버전(**v9.1 v1.1**)에서는:  
  - S1~S4 가중합 → 정상 동작  
  - 앵커 기반 보너스 → 정상 동작  
  - 복음서/발화/마진/비율 제어 → 미적용  

본 MD는 **현재 구현된 동작**을 기준으로 작성되었으며, 미적용 항목은 향후 버전에서 확장 가능합니다.

### 9.7.1 미적용 정책 파라미터 목록 (현 버전)

|항목|시트|상태|
|---|---|---|
|bonus_gospel|priority_rules|선언만 존재|
|bonus_wcf|priority_rules|선언만 존재|
|secondary_ratio|weights|선언만 존재|
|primary_margin|weights|선언만 존재|

## 9.8 전체 파이프라인 개요

> **추가(정본 · v9.1 v1.1):** 점수 산정은 9.6에서 정의한 대로  
> **S1~S4 신호 추출 → score_total(가중합) → priority_score(보너스+정규화)** 순서로 동작합니다.

### 9.8.1 블록 다이어그램(텍스트 버전)
1. 사진 입력
    
2. **지각 레이어**: 피사체/장면/텍스트(OCR)/랜드마크 태깅
    
3. **컨텍스트 추론**: 시간·요일·계절·날씨·기기 언어
    
4. **상징 매핑**: 태그→성경적 상징(예: 산, 길, 병상 등)
    
5. **주제 매핑**: 상징→24개 **주제(Topic)**
    
6. **쿼리 벡터 생성**: 태그·상징·주제·컨텍스트를 하나의 **임베딩**으로 만듦
    
7. **벡터 검색**: 성경 구절 임베딩 DB에서 Top-K 후보 구절 검색
    
8. **재랭커(Re-ranker)**: 후보 구절과 현재 사진/주제의 적합도 심층 평가
    
9. **가이드라인 엔진**: 교리·민감도 규칙(Allow/Attenuate/Block) 적용
    
10. **다양성 픽(Diversity Pick)**: 최대 2절(Top-1, ALT-1) 선정
    
11. **설명 카드 생성**: "왜 이 구절인가?"를 **Why-score** 기반으로 요약
    
12. **사후 기록(PostAffection)**: 감정·기도·메모 기록 + 복습 스케줄 생성
    

### 9.8.2 단계별 요약 표
|단계|이름|입력|출력|
|---|---|---|---|
|1|**지각 레이어**|사진|태그(피사체·장면·OCR·랜드마크)|
|2|**컨텍스트 추론**|EXIF, 기기 정보|시간, 요일, 계절, 언어 등|
|3|**상징 매핑**|태그|상징 리스트|
|4|**주제 매핑(24 Topics)**|상징, 태그|주제(Topic) 가중치 벡터|
|5|**쿼리 벡터 생성**|태그, 주제, 컨텍스트|쿼리 임베딩 벡터|
|6|**벡터 검색**|쿼리 벡터|후보 구절 Top-K|
|7|**재랭커**|후보 구절 + 모든 컨텍스트|점수 리스트|
|8|**가이드라인 엔진**|점수 리스트, 규칙 테이블|필터링·감쇠된 점수 리스트|
|9|**다양성 픽**|필터링된 점수 리스트|최종 1–2절(Top-1, ALT-1)|
|10|**설명 카드 생성**|최종 구절, 태그, 주제, 근거|Why 카드 텍스트|
|11|**사후 기록 로직**|사용자 입력(감정, 메모, 기도)|PostAffection 이벤트|

### 9.8.3 시스템 아키텍처(엔드투엔드 레이어 구성)
위 단계별 파이프라인을 **어디서(앱/서버) 어떤 데이터와 함께 처리하는지**를 한 눈에 보기 위한 구조입니다.

_엔드투엔드 플로우(요약)_  
지각(Perception) → 상징(P1) → 신학 주제(P2) → 컨텍스트 보정(P3) → 임베딩 검색/재랭킹 → Top-1/2 선출 → 설명 카드 생성 → 사후 감정/기도 기록 → 월드맵(선택 공개) 집계

|레이어|앱(온디바이스)|서버|데이터/정책|
|---|---|---|---|
|지각|객체/장면/CLIP/OCR/랜드마크 인식, 시간대·기기 정보 추출|—|—|
|주제화|상징→주제 1차 매핑(경량 룰/모델)|주제 보정(P2, P3 레벨 신학·컨텍스트 보정)|24 주제·120 라벨, SymbolThemeMap 매트릭스|
|검색|오프라인 코어팩 기반 후보 구절(제한된 로컬 추천)|전체 임베딩 DB 벡터 검색 + 재랭킹|임베딩 벡터, 가이드라인 정책(Allow/Attenuate/Block)|
|결과|최종 1–2절 및 설명 카드 표시, 감정/기도 입력 UI 처리|Why-score 및 Why 로그 저장, 월드맵 집계|위치 좌표는 원칙적 비보관·퍼징, 민감도/프라이버시 정책 적용|

이 표를 통해 **어디까지를 온디바이스에서 처리하고, 어디서부터 서버·정책 레이어가 개입하는지**를 개발자들이 바로 이해할 수 있도록 했습니다.

### 9.8.4 파이프라인(초등학생도 이해 버전)
- 사진 읽기 → 힌트 만들기 → 상징·주제로 바꾸기 → 구절 찾기 → 똑똑한 재정렬 → 교리 점검 → 1–2절 + 짧은 설명 → 사후 감정 기록
    

> 위 흐름은 9.3.1~9.3.3에서 정의한 동일 파이프라인을 **어린이·비개발자도 이해하기 쉬운 언어**로 압축한 설명입니다.

### 9.8.5 의사코드(개발팀 참고용)
```pseudo
function recommendVerses(photo):
  tags = perceive(photo)
  symbols = map_to_symbols(tags)
  themes = symbols_to_themes(symbols)
  qvec = build_query_vector(tags, themes, context=weekday/season/weather)
  cands = vector_search(VerseDB, qvec, topK=50)
  scored = cross_encode(cands, tags, themes)
  scored2 = doctrinal_guard(scored, rules=EJTP_rules)
  final = diversity_pick(scored2, n=2)
  explain = make_explain_card(tags, themes, final)
  return {verses: final, reason: explain, themes: themes}
```

> 이 의사코드는 실제 구현 언어(Typescript, Kotlin 등)와 무관하게, 9장에서 정의한 각 모듈이 어떤 순서로 호출되는지 **개발팀에 전달하기 위한 표준 흐름**입니다.

---

### 9.8.3 시스템 개요 (개발자용 요약)
입력(이미지, EXIF, OCR) → **Perception** → **P1 상징** → **P2 주제** → **P3/S 보정** → **검색 Top-K/재랭킹** → **가이드라인 필터** → **Top-1 구절 + 이유 + 태그 + 점수**.

|No.|블록|입력/출력|비고|
|--:|---|---|---|
|1|Perception|img/EXIF/OCR → 라벨·장면·텍스트·POI·시각특징|온디바이스 우선(≤120ms)|
|2|P1 상징|라벨/장면/OCR → SYM-* 정규화|`P1_score=max(conf_i)×weight`|
|3|P2 주제|상징 집합 → 주제 가중 합산|그래프 간선 w_map|
|4|P3/S 보정|시간/장소/시각특징/군중성|±0.05~0.15 보정|
|5|검색/랭크|Top-K 벡터검색 → 재랭킹|KO 기본, EN 병기|
|6|가이드라인|교리/톤/민감 정책 적용|심판 단독 금지 등|
|7|응답|구절(ko/en), 이유, 태그, 점수, 안전플래그|Top-1(+보조1)|

### 9.8.4 I/O 계약 (추천 API 입·출력)
#### 9.8.4.1 입력 (클라이언트 → 추천 API)
|No.|필드|형식/설명|
|--:|---|---|
|1|image|긴 변 2048px, sRGB, ≤5MB|
|2|exif_time|ISO-8601, 서버 UTC 정규화|
|3|exif_location|lat,lon → 저장 시 **지오해시(6–7자)**|
|4|device_lang|`ko-KR` 기본, `en-US` 선택|
|5|network_state|`online`/`offline`|
|6|ocr_text|선택, 전처리·정규화 적용|
|7|user_flags|JSON(아동/민감 힌트 등)|

#### 9.8.4.2 출력 (표준 JSON)
|No.|필드|형식/설명|
|--:|---|---|
|1|verses[≤2]|`{book,chapter,v_from,v_to,text_ko,text_en?}` (첫 요소가 최종)|
|2|reasons|2–3문장: **상징→주제→근거** 인과|
|3|themes|최종 주제 태그(코드 ID) 2–4개|
|4|scores|`ImgRel/ContextFit/ThemeOrthodoxy/Penalty` 0.0–1.0|
|5|safety_flags|민감/완화/배제 코드 배열|

## 9.9 핵심 데이터 엔티티 구조
### 9.9.1 엔티티 개요
|엔티티 이름|역할 설명|
|---|---|
|**PhotoEvent**|한 번의 사진 촬영/선택 사건|
|**PerceptionResult**|사진에 대한 지각 결과(태그·컨텍스트)|
|**RecommendationResult**|추천된 구절·점수·근거·플래그|
|**Verse**|성경 한 절(또는 두 절 묶음)|
|**SymbolThemeMap**|태그/상징 ↔ 주제(Topic) 매핑|
|**ThemeVerseMap**|주제 ↔ 구절 매핑|
|**PostAffection**|추천 이후 사용자의 감정·기도·메모 기록|
|**OfflinePack**|오프라인 상황에서 사용할 코어 구절·임베딩 묶음|
|**EmotionVector**|표정·텍스트 등에서 추출된 감정 확률 벡터 및 대표 감정 태그|
|**EmotionScriptureMap**|감정·상황 키 ↔ 성경 구절 리스트 매핑 규칙|

### 9.9.2 PhotoEvent
- 목적: "사진 한 장"에 대해 **무엇이 입력되었는지**를 표현
    

|필드명|타입|설명|
|---|---|---|
|event_id|string|고유 ID|
|user_id|string|사용자 ID(익명/가명 가능)|
|image_id|string|이미지 저장 키(or 해시)|
|created_at|datetime|이벤트 발생 시각|
|exif_time|datetime|사진 촬영 시각(있다면)|
|device_locale|string|기기 언어(예: `ko-KR`, `en-US`)|
|country_code|string|국가 코드(예: `KR`, `US`)|
|privacy_flags|json|프라이버시 관련 플래그(위치 비저장, 민감 이미지 등)|

### 9.9.3 PerceptionResult
|필드명|타입|설명|
|---|---|---|
|event_id|string|PhotoEvent와 1:1 연결|
|obj_tags|json|피사체 라벨 리스트(예: 사람, 산, 병원)|
|scene_tags|json|장면 라벨(실내/실외, 도시/자연 등)|
|ocr_text|string|OCR로 읽은 텍스트 요약|
|landmark|string|랜드마크 라벨(있다면)|
|weekday|int|요일(0~6)|
|season|string|계절(예: SPRING, SUMMER)|
|time_bucket|string|시간대(예: MORNING, EVENING)|

### 9.9.4 RecommendationResult
|필드명|타입|설명|
|---|---|---|
|event_id|string|PhotoEvent와 연결|
|top1_verse_id|string|최종 추천 1순위 구절 ID|
|alt1_verse_id|string|대체 구절 ID(있다면)|
|themes|json|주제(Topic) 리스트 및 가중치|
|scores|json|이미지 적합도, 컨텍스트 적합도, 교리 적합도 등|
|filter_hits|json|가이드라인 엔진에서 적용된 규칙 목록|
|why_card_text|string|설명 카드 텍스트("왜 이 구절인가")|

### 9.9.5 Verse
|필드명|타입|설명|
|---|---|---|
|verse_id|string|고유 ID|
|book|string|성경 책 이름|
|chapter|int|장 번호|
|verse_from|int|시작 절|
|verse_to|int|끝 절(1절만이면 = verse_from)|
|text_ko|text|개역개정 본문|
|text_en|text|NIV 본문(옵션)|
|topic_ids|json|연관 주제(Topic) 리스트|
|symbol_ids|json|연관 상징 리스트|
|embed_vector|vector|임베딩 벡터|
|doctrinal_tag|json|교리 관련 메모(주의/금지 플래그 등)|

### 9.9.6 PostAffection
|필드명|타입|설명|
|---|---|---|
|event_id|string|PhotoEvent와 1:1 연결|
|verse_id|string|사용자가 실제로 묵상한 구절 ID|
|feeling_tags|json|감정 태그(위로, 감사, 슬픔 등)|
|memo|text|자유 메모|
|prayed|bool|기도 여부|
|next_reviews|json|1/3/7/30일 복습 예약 정보|

### 9.9.7 엔티티 요약 스키마(정식 정의)
|엔티티|필드 요약|
|---|---|
|PhotoEvent|{ event_id, user_id, exif_time, device_locale, country_code, privacy_flags }|
|PerceptionResult|{ obj_tags[], scene_tags[], ocr_text, landmark, weekday, season, time_bucket }|
|Verse|{ verse_id, book, chapter, verse_from, verse_to, text_ko, text_en, topic_ids[], symbol_ids[], embed_vector, doctrinal_tag }|
|Mapping|{ symbol↔theme[], theme↔verse_ids[], guidelines{doctrinal_rules[], regional[]} }|
|PostAffection|{ user_id, event_id, verse_id, feeling_tags[], memo, prayed, next_reviews, timestamp }|
|GeoPin|{ pin_id, photo_id, verse_id, geohash, jittered_lat, jittered_lon, time_bucket, visibility, k_score, flags{sensitive, child, church} }|

#### 9.9.8 GeoPin 기반 실전 예시(지도·위치 연동)
아래 표는 **GeoPin·time_bucket·위치 컨텍스트**가 추천 엔진과 어떻게 연결되는지 보여주는 예시입니다. 실제 수치·정책은 9.7 데이터북 및 가이드라인 엔진 규칙에 따라 결정됩니다.

|예시|탐지/문맥|추천 구절(개역개정)|대안 구절|설명|
|---|---|---|---|---|
|A 해변 일출(제주, 주일 새벽)|바다·새벽·주일·해안/항구 컨텍스트|예레미야애가 3:22–23|시편 130:5 등|새벽의 ‘새로움’과 바다·빛 상징으로 소망·신실 주제 강화|
|B 도심 우천(서울, 평일 밤)|도심·야간·우천·인도/불안 컨텍스트|시편 23:4|이사야 41:10|어두운 비 오는 도시 한가운데에서도 하나님이 함께 인도하신다는 주제를 강조|

### 9.9.7 EmotionVector
- 목적: **감정 인식 모델**이 산출한 7개 기본 감정 확률과 대표 감정 태그를 구조화하여 저장
    

|필드명|타입|설명|
|---|---|---|
|event_id|string|PhotoEvent와 1:1 연결|
|emotion_probs|json|7개 기본 감정(행복·놀람·슬픔·분노·혐오·두려움·중립)의 확률 벡터|
|primary_label|string|가장 높은 확률을 갖는 대표 감정 라벨|
|intensity|float|감정 강도(0.0~1.0)|
|source|string|감정 소스(`face_model`, `manual`, `text_model` 등)|
|updated_at|datetime|마지막 계산 시각|

### 9.9.8 EmotionScriptureMap
- 목적: **감정+상황 조합 키**를 성경 구절 리스트와 연결하는 규칙 DB 정의
    

|필드명|타입|설명|
|---|---|---|
|key_id|string|매핑 키 ID(예: `sad_alone`, `joy_wedding`)|
|emotion_key|string|정규화된 감정+상황 문자열 키|
|topic_ids|json|이 키와 연관된 24개 주제 중 주요 주제 ID 리스트|
|verse_ids|json|기본 추천 대상이 되는 Verse ID 리스트|
|priority|int|동일 키 내 구절 랭킹 우선순위|
|notes|text|신학적 유의사항·사용 메모|
|updated_at|datetime|마지막 수정 시각|

---

## 9.10 AI 모듈 상세
### 9.10.1 지각 레이어
#### 9.10.1.1 입력·전처리 & 민감 라우팅(Perception 연결)
이 절은 **Perception(지각) 실행 직전**에 수행되는 입력 표준화·전처리와, 민감 상황을 **안전 플로우로 라우팅**하기 위한 규칙을 정의합니다. (Perception 결과는 이후 P1→P2→P3/S→검색/재랭킹으로 이어짐)

##### 9.10.1.1.1 사용자 플로우(텍스트 상태도)
촬영/업로드  
→ EXIF 확인(회전/시각)  
→ 입력 표준화(리사이즈 + 레터박스)  
→ 민감 라우팅(safety_flags 산출)  
→ Perception 실행(객체/장면/CLIP/OCR/선택: 랜드마크)  
→ 정규화 태그 패킹(JSON)  
→ P1 상징 → P2 주제 → P3/S 보정 → 추천/재랭킹  
→ Top-1(±보조) + Why 카드  
→ (옵션) 사후 기록(감정/기도/메모)

##### 9.10.1.1.2 전처리(표준화) 규칙 표
|단계|입력|처리 규칙(권장)|출력|로그(권장)|
|---|---|---|---|---|
|1|이미지 + EXIF|EXIF Orientation 적용(정방향), 촬영시각 추출(없으면 업로드 시각)|정방향 이미지, 기준 시각|exif_present, orientation_applied, time_source|
|2|원본 이미지|긴 변 2048px 기준 리사이즈, 비율 유지, 레터박스(패딩)로 정사각/지정 비율 정규화|모델 입력 텐서(표준 크기)|resize_scale, pad(px), input_size|
|3|색공간/품질|sRGB 가정, 과도한 샤프/노이즈 억제(선택), 압축 품질 표준화|안정적 시각 피처|color_space, jpeg_q|
|4|OCR 입력|OCR 텍스트 정규화(공백/개행, 기호 정리, 금칙어·개인정보 패턴 마스킹)|ocr_text_norm|ocr_len, pii_masked|
|5|위치(선택)|좌표 저장 금지 원칙. 필요 시 지오해시(6–7자)로만 변환 후 사용|geo_ctx(거친 단위)|geo_mode(off/geohash), geohash_len|

##### 9.10.1.1.3 민감 라우팅(safety_flags) 규칙(요약)
- 목적: 민감 사진(아동/의료/장례/정치·갈등/정밀 위치 등)에서 **추천 톤·공개 정책·차단 정책**을 일관되게 적용하기 위함
    
- 출력: `safety_flags[]` (예: `child_present`, `medical_scene`, `funeral_scene`, `politics_conflict`, `precise_location_hint`)
    
- 적용 위치
    
    - **Perception 이전**: 공유 기본값/저장 정책(비공개 권고 등) 결정
        
    - **Top-1 직전**: 가이드라인 엔진에서 Allow/Attenuate/Block을 최종 적용(9.6.4, 9.7 policies 시트와 연결)
        

|민감 유형|탐지 힌트(예시)|라우팅 기본값(권장)|후속 영향|
|---|---|---|---|
|아동/의료|얼굴/유아 키포인트, 병원/병실, 의료기기, OCR(ER 등)|비공개 권고 + 외부 공유 억제|위로/보호 톤 우선, 민감 본문 감쇠/차단|
|장례/병상|관/조문/묘지/병상 장면|위로/소망 본문 우선|정죄 단독 구절 차단(가이드라인)|
|정치/갈등|현수막/시위/갈등 상징, OCR(정당/구호)|중립 권면 우선|선동/분열 조장 문구 감쇠/차단|
|정밀 위치|좌표/주소/차량번호/학교명 등 OCR 패턴|좌표 저장 금지 + 공유 제한|지오해시/퍼징만 허용, 노출 최소화|

- 역할: 사진 안의 **피사체·장면·텍스트·랜드마크**를 인식
    
- 내부 구성
    
    - **객체 탐지 모델** (예: 사람, 나무, 도로, 침대, 십자가 등)
        
    - **장면 분류 모델** (실내/실외, 도시/자연, 병원/교회 등)
        
    - **OCR 엔진** (간판, 문서, 디스플레이 텍스트)
        
    - **랜드마크 인식** (교회 외관, 산/바다, 도시 스카이라인 등)
        
- 품질 기준(예시)
    
    - 주요 객체 Top-5 인식 **정확도 ≥ 80%**
        
    - 민감 장면(아동, 병원, 장례 등) **리콜 ≥ 90%**
        
- 세부 서브모듈 설계
    
    - **감정 인식 모델(Emotion Analysis Model)**: MobileNetV2 계열 경량 CNN + Dense 분류 헤드, 64×64 얼굴 크롭 입력, 7개 기본 감정(행복·놀람·슬픔·분노·혐오·두려움·중립)에 대한 softmax 확률 출력.
        
    - **객체 탐지 모델(Object Detection Model)**: SSD MobileNet V3 또는 YOLOv5n 급 1단계 감지 모델, COCO 계열 80종 이상 객체 지원, INT8 양자화 TFLite로 변환, 신뢰도 60% 이상 상위 3개 객체만 태그로 사용.
        
    - **도메인 확장 태그**: 십자가, 교회 건물, 강단 등 일반 COCO에 없는 상징 객체는 커스텀 데이터로 추가 학습하여 성경 맥락 관련 장면 인식률을 높인다.
        
- 온디바이스
    
    - **지각 레이어**(경량 모델: 감정 인식·객체 탐지 TFLite, 단일 사진 기준 50~150ms)
        
    - 오프라인팩 기반 간단 추천
        
- 서버
    
    - 전체 벡터 검색/재랭킹
        
    - 가이드라인 엔진
        
    - 월드맵·통계 등
        

##### 9.10.1.1.4 상태·트리거·조치(TSV)
아래 표는 9.5.1.1.1의 사용자 플로우를 **상태 머신 관점**으로 쪼갠 것입니다. 개발·QA·UX가 같은 용어로 "지금 무슨 단계이며, 무엇을 해야 하고, 사용자에게 무엇을 보여줄지"를 합의할 때 사용합니다.

|No.|상태|진입 트리거|핵심 조치|UX 노출|
|--:|---|---|---|---|
|1|EXIF_NORMALIZE|이미지 수신|Orientation 정방향, 촬영시각 추출|없음(백그라운드)|
|2|INPUT_STANDARDIZE|모델 입력 준비|리사이즈 + 레터박스 패딩(규격 통일)|없음|
|3|SAFETY_ROUTING|민감 신호 가능성|얼굴/아동/의료 탐지 시 safety_flags만 유지|공유/공개 권고(필요 시)|
|4|PERCEPTION_RUN|전처리 완료|objects/scenes/clip/ocr/(선택)landmark 산출|로딩(짧게)|
|5|LOW_CONFIDENCE|역광/야간/블러 등|conf 저하 감지 → 추천 보수화|“정확도 낮음” 1줄(선택)|
|6|PACK_JSON|Perception 완료|정규화·필터·Top-K 적용 후 JSON 패킹|없음|
|7|RECOMMEND|태그 패킹 완료|상징/주제/보정/재랭킹 후 결과 생성|Top-1 + Why 카드|

```tsv
No	상태	진입 트리거	핵심 조치	UX 노출
1	EXIF_NORMALIZE	이미지 수신	Orientation 정방향, 촬영시각 추출	없음(백그라운드)
2	INPUT_STANDARDIZE	모델 입력 준비	리사이즈 + 레터박스 패딩(규격 통일)	없음
3	SAFETY_ROUTING	민감 신호 가능성	얼굴/아동/의료 탐지 시 safety_flags만 유지	공유/공개 권고(필요 시)
4	PERCEPTION_RUN	전처리 완료	objects/scenes/clip/ocr/(선택)landmark 산출	로딩(짧게)
5	LOW_CONFIDENCE	역광/야간/블러 등	conf 저하 감지 → 추천 보수화	“정확도 낮음” 1줄(선택)
6	PACK_JSON	Perception 완료	정규화·필터·Top-K 적용 후 JSON 패킹	없음
7	RECOMMEND	태그 패킹 완료	상징/주제/보정/재랭킹 후 결과 생성	Top-1 + Why 카드
```

### 9.10.2 상징(Signal→Symbol) 매핑
P1 레이어는 지각(Perception) 단계에서 추출된 **라벨·장면·CLIP(유사 텍스트)·OCR·POI 신호**를 성경적 상징(Symbol) 단위로 정리하고 가중치를 부여하는 구간입니다. 이 단계의 출력이 곧 P2 주제 레이어의 핵심 입력이 됩니다.

- Perception → Symbol 변환: 객체/장면/CLIP/OCR 태그를 **상징 코드(SYM-**)로 정규화
    
- 스코어링: `P1_score = max(conf_i) × weight_sym`
    
- 충돌 처리: 상위 두 상징 점수 차이가 작을 때 `|Δscore| < τ(=0.08)`이면 **복합 상징 병치** 허용
    
- 정책: 장례·병상·아동·전쟁 등 **민감 상징은 기본 Attenuate** 후, 위로/보호 톤 위주의 주제로 넘김
    

#### 9.10.2.1 P1 상징 레이어 (기획 의도 + 코어 상징 테이블)
P1 상징 레이어는 다음 **5개 코어 군**으로 구성됩니다. 각 군은 9.7 데이터북의 `objects` 시트와 코드(SYM-*)로 연결되며, 아래 표는 **기획 의도·대표 주제·개발 메모**를 정리한 기준 버전입니다.

##### 9.10.2.1.1 자연(지형·천체·기상) — 10코어
|No.|상징|의미/역할|주된 매핑(예시 주제)|개발자 메모|
|--:|---|---|---|---|
|1|산|피난/견고/시련|인도·보호·거룩|윤곽/고도·수평선 구분|
|2|바다|혼돈/깊음/광활|창조·권능·소망|수평선/파도 패턴|
|3|강·샘|생명/공급|회복·은혜·기억|흐름성/연안 구조|
|4|광야|시험/의존|훈련·소명|식생 희소/고립성|
|5|숲·나무|생장/의지|번성·정의|수관/밀도 지표|
|6|꽃·풀|덧없음/은혜|겸손·감사|색채/비율≥3%|
|7|해·빛|창조/인도/영광|소망·계시|역광/색온도 트리거|
|8|달·별|시간/질서|기억·약속|야간·점광 패턴|
|9|비·눈|은혜/정결|회복·자비|강수/텍스처|
|10|폭풍·바람|위기/전환|보호·신뢰|구름질/흐림도 급변|

##### 9.10.2.1.2 생명(식물·동물·인간·표정) — 9코어
|No.|상징|의미/역할|주된 매핑(예시 주제)|개발자 메모|
|--:|---|---|---|---|
|1|씨앗·열매|시작/결과·성장·충만|창조/섭리, 지혜/훈련, 감사|과일/종자 형태, 포도원 OCR 동의어 관리|
|2|포도나무·가지|연합·의존·열매|공동체/연합, 소명/순종|덩굴형·송이 패턴, 표지판 OCR 우선|
|3|양|보호 필요·목자 관계|사랑/긍휼, 인도/소망|종 분류 conf≥0.8, 군집 보정|
|4|사자|권세·위엄·경계|공의/정의, 소명/순종|갈기/체형, 엠블럼 OCR 보조|
|5|비둘기|평화·성령 상징|위로/평강, 예배/감사|흰색 소형 조류·올리브 가지|
|6|물고기|공급·증언·사명|선교/증언, 감사|ΙΧΘΥΣ/상점 구분, 표식 OCR|
|7|어린아이|보호·양육·순수|사랑/긍휼, 공동체/연합|유모차/젖병 키포인트, 민감 플래그|
|8|노인|지혜·기억·돌봄|지혜/훈련, 사랑/긍휼|보행보조구/백발, 존칭 톤|
|9|인간 표정|정서 단서|위로/평강, 사랑/긍휼|감정 conf≥0.60, 분노/공포 완화|

##### 9.10.2.1.3 인공물(인간 제작물) — 10코어
|No.|상징|의미/역할|주된 매핑(예시 주제)|개발자 메모|
|--:|---|---|---|---|
|1|집·가정|쉼·돌봄|공동체/연합, 사랑/긍휼|지붕/창호, 간판 OCR|
|2|도시·거리|세상·소명 현장|선교/증언, 공의/정의|간판 밀도/교통량, 야간 보정|
|3|길·다리|인도·결단·연결|인도/소망, 지혜/훈련|차선/소실점, 표지 OCR|
|4|학교|배움·훈련|지혜/훈련, 소명/순종|교복/강의실/간판 OCR|
|5|병원|치유·위로·보호|위로/평강, 사랑/긍휼|ER/응급실 OCR, 위로 톤|
|6|시장·상점|생계·공정|공의/정의, 감사|저울/가격표 OCR, 로고 블러|
|7|법정·재판|정의·책임|공의/정의, 지혜/훈련|법봉/저울 아이콘, 균형 톤|
|8|공장·도구·차/기차/비행기|노동·생산·이동|소명/순종, 청지기|공구/기계/탑승권 OCR|
|9|교회·예배당|예배·연합·기억|예배/감사, 공동체/연합|종탑/십자가/예배 인파|
|10|무덤·기념|유한성·기억·소망|위로/평강, 구원/복음|묘비/헌화, 공유 제한 검토|

##### 9.10.2.1.4 인간 활동 — 10코어
|No.|상징|의미/역할|주된 매핑(예시 주제)|개발자 메모|
|--:|---|---|---|---|
|1|노동·수고|책임·정직·청지기|소명/순종, 공의/정의|작업복/공구 포즈|
|2|농사·수확|씨앗→열매·인내|지혜/훈련, 감사|작물/계절 보정|
|3|공부·독서|배움·분별|지혜/훈련, 소명/순종|책/필기구/성경 OCR|
|4|음악·예술|찬양·표현·재능|예배/감사, 공동체/연합|악기/무대/합창|
|5|스포츠·경기|절제·경주·상급|지혜/훈련, 소명/순종|트랙/메달/유니폼|
|6|결혼·잔치|언약·기쁨·연합|공동체/연합, 예배/감사|반지/부케/예식장 OCR|
|7|육아·돌봄|보호·양육·책임|사랑/긍휼, 공동체/연합|아기용품/포옹, 민감 플래그|
|8|여행·순례|보냄·인도·보호|인도/소망, 선교/증언|공항/탑승권/배낭|
|9|전쟁·무기|갈등·위험·분별|공의/정의, 위로/평강|무기 탐지 시 완화/화해 톤|
|10|정치·회의|공공 판단·지혜|지혜/훈련, 공의/정의|의사봉/회의실/현수막|

##### 9.10.2.1.5 공간·장면 — 7코어
|No.|상징|의미/역할|주된 매핑(예시 주제)|개발자 메모|
|--:|---|---|---|---|
|1|실내·집중|묵상·학습·기도|지혜/훈련, 예배/감사|실내 조도/정숙도|
|2|실외·광장|개방·선포·연합|선교/증언, 공동체/연합|확장 공간/현수막|
|3|군중|긍휼·질서·연대|사랑/긍휼, 공동체/연합|인원/밀도, 얼굴 블러 ON|
|4|고립·홀로|성찰·임재·보호|위로/평강, 인도/소망|단일 인물/야간 보정|
|5|골목·어둑함|경계·분별·지혜|지혜/훈련, 보호|저조도/협폭, 공포 금지 톤|
|6|병실·대기실|연약함·위로·기다림|위로/평강, 사랑/긍휼|의료기기, 공유 제한|
|7|성지·랜드마크|기억·예배·감사|예배/감사, 선교/증언|랜드마크 POI/OCR|

### 9.10.2 상징(Signal→Symbol) 매핑
지각 레이어에서 나온 객체·장면·OCR·POI 신호를 **성경적 상징(Symbol)** 단위로 정규화하고, 각 상징에 가중치를 부여해 P2 주제 레이어의 입력으로 사용하는 단계입니다. 이 절에서는 P1 상징 레이어의 설계 의도와, 핵심 상징 테이블(코어 상징 세트)을 정식 번호 체계로 정리합니다.

#### 9.10.2.1 P1 상징 레이어 (기획 의도 + 기술 규칙)
Perception 라벨/장면/OCR/POI 신호를 **성경적 상징(Symbol)** 단위로 표준화하고 가중치를 부여합니다. 출력은 P2 주제 레이어의 핵심 피처입니다.  
**스코어링** `P1_score = max(conf_i) × weight_sym`  
**충돌** `|Δscore| < τ(=0.08)` → 복합 상징 병치  
**정책** 민감 상징 **완화(Attenuate)** + 톤 가이드

#### 9.10.2.2 자연(지형·천체·기상) — 10코어
|No.|상징|의미/역할|주된 매핑(예시 주제)|개발자 메모|
|--:|---|---|---|---|
|1|산|피난/견고/시련|인도·보호·거룩|윤곽/고도·수평선 구분|
|2|바다|혼돈/깊음/광활|창조·권능·소망|수평선/파도 패턴|
|3|강·샘|생명/공급|회복·은혜·기억|흐름성/연안 구조|
|4|광야|시험/의존|훈련·소명|식생 희소/고립성|
|5|숲·나무|생장/의지|번성·정의|수관/밀도 지표|
|6|꽃·풀|덧없음/은혜|겸손·감사|색채/비율≥3%|
|7|해·빛|창조/인도/영광|소망·계시|역광/색온도 트리거|
|8|달·별|시간/질서|기억·약속|야간·점광 패턴|
|9|비·눈|은혜/정결|회복·자비|강수/텍스처|
|10|폭풍·바람|위기/전환|보호·신뢰|구름질/흐림도 급변|

#### 9.10.2.3 생명(식물·동물·인간·표정) — 9코어
|No.|상징|의미/역할|주된 매핑(예시 주제)|개발자 메모|
|--:|---|---|---|---|
|1|씨앗·열매|시작/결과·성장·충만|창조/섭리, 지혜/훈련, 감사|과일/종자 형태, 포도원 OCR 동의어 관리|
|2|포도나무·가지|연합·의존·열매|공동체/연합, 소명/순종|덩굴형·송이 패턴, 표지판 OCR 우선|
|3|양|보호 필요·목자 관계|사랑/긍휼, 인도/소망|종 분류 conf≥0.8, 군집 보정|
|4|사자|권세·위엄·경계|공의/정의, 소명/순종|갈기/체형, 엠블럼 OCR 보조|
|5|비둘기|평화·성령 상징|위로/평강, 예배/감사|흰색 소형 조류·올리브 가지|
|6|물고기|공급·증언·사명|선교/증언, 감사|ΙΧΘΥΣ/상점 구분, 표식 OCR|
|7|어린아이|보호·양육·순수|사랑/긍휼, 공동체/연합|유모차/젖병 키포인트, 민감 플래그|
|8|노인|지혜·기억·돌봄|지혜/훈련, 사랑/긍휼|보행보조구/백발, 존칭 톤|
|9|인간 표정|정서 단서|위로/평강, 사랑/긍휼|감정 conf≥0.60, 분노/공포 완화|

#### 9.10.2.4 인공물(인간 제작물) — 10코어
|No.|상징|의미/역할|주된 매핑(예시 주제)|개발자 메모|
|--:|---|---|---|---|
|1|집·가정|쉼·돌봄|공동체/연합, 사랑/긍휼|지붕/창호, 간판 OCR|
|2|도시·거리|세상·소명 현장|선교/증언, 공의/정의|간판 밀도/교통량, 야간 보정|
|3|길·다리|인도·결단·연결|인도/소망, 지혜/훈련|차선/소실점, 표지 OCR|
|4|학교|배움·훈련|지혜/훈련, 소명/순종|교복/강의실/간판 OCR|
|5|병원|치유·위로·보호|위로/평강, 사랑/긍휼|ER/응급실 OCR, 위로 톤|
|6|시장·상점|생계·공정|공의/정의, 감사|저울/가격표 OCR, 로고 블러|
|7|법정·재판|정의·책임|공의/정의, 지혜/훈련|법봉/저울 아이콘, 균형 톤|
|8|공장·도구·차/기차/비행기|노동·생산·이동|소명/순종, 청지기|공구/기계/탑승권 OCR|
|9|교회·예배당|예배·연합·기억|예배/감사, 공동체/연합|종탑/십자가/예배 인파|
|10|무덤·기념|유한성·기억·소망|위로/평강, 구원/복음|묘비/헌화, 공유 제한 검토|

#### 9.10.2.5 인간 활동 — 10코어
|No.|상징|의미/역할|주된 매핑(예시 주제)|개발자 메모|
|--:|---|---|---|---|
|1|노동·수고|책임·정직·청지기|소명/순종, 공의/정의|작업복/공구 포즈|
|2|농사·수확|씨앗→열매·인내|지혜/훈련, 감사|작물/계절 보정|
|3|공부·독서|배움·분별|지혜/훈련, 소명/순종|책/필기구/성경 OCR|
|4|음악·예술|찬양·표현·재능|예배/감사, 공동체/연합|악기/무대/합창|
|5|스포츠·경기|절제·경주·상급|지혜/훈련, 소명/순종|트랙/메달/유니폼|
|6|결혼·잔치|언약·기쁨·연합|공동체/연합, 예배/감사|반지/부케/예식장 OCR|
|7|육아·돌봄|보호·양육·책임|사랑/긍휼, 공동체/연합|아기용품/포옹, 민감 플래그|
|8|여행·순례|보냄·인도·보호|인도/소망, 선교/증언|공항/탑승권/배낭|
|9|전쟁·무기|갈등·위험·분별|공의/정의, 위로/평강|무기 탐지 시 완화/화해 톤|
|10|정치·회의|공공 판단·지혜|지혜/훈련, 공의/정의|의사봉/회의실/현수막|

#### 9.10.2.6 공간·장면 — 7코어
|No.|상징|의미/역할|주된 매핑(예시 주제)|개발자 메모|
|--:|---|---|---|---|
|1|실내·집중|묵상·학습·기도|지혜/훈련, 예배/감사|실내 조도/정숙도|
|2|실외·광장|개방·선포·연합|선교/증언, 공동체/연합|확장 공간/현수막|
|3|군중|긍휼·질서·연대|사랑/긍휼, 공동체/연합|인원/밀도, 얼굴 블러 ON|
|4|고립·홀로|성찰·임재·보호|위로/평강, 인도/소망|단일 인물/야간 보정|
|5|골목·어둑함|경계·분별·지혜|지혜/훈련, 보호|저조도/협폭, 공포 금지 톤|
|6|병실·대기실|연약함·위로·기다림|위로/평강, 사랑/긍휼|의료기기, 공유 제한|
|7|성지·랜드마크|기억·예배·감사|예배/감사, 선교/증언|랜드마크 POI/OCR|

## 9.11 데이터북(Data Book) 구조
### 9.11.1 데이터북 개요
- 단일 **엑셀/CSV 세트**로 관리되는, 본 프로젝트의 핵심 지식 구조.
    
- 구성
    
    - **topics** 시트: 24개 주제 정의
        
    - **objects** 시트: 120개 라벨 정의
        
    - **mapping_object_topic** 시트: 라벨×주제 가중치 매트릭스
        
    - **policies** 시트: Allow/Attenuate/Block 규칙
        
    - **notes** 시트: 신학·데이터 메모
        

### 9.11.2 topics 시트
|필드명|설명|
|---|---|
|topic_id|주제 ID(정수 또는 문자열)|
|slug|영문 슬러그|
|name_ko|한글 이름|
|name_en|영문 이름|
|desc_ko|한글 설명|
|desc_en|영문 설명|
|policy_tag|정책 관련 태그 목록|
|anchor_refs|대표 성경 구절 ID 리스트|
|updated_at|마지막 수정일|

### 9.11.3 objects 시트
|필드명|설명|
|---|---|
|object_id|라벨 ID|
|slug|영문 슬러그|
|name_ko|한글 이름(예: 산, 길, 침대)|
|name_en|영문 이름|
|synonyms_ko|한글 동의어 리스트|
|synonyms_en|영문 동의어 리스트|
|category|상위 카테고리(사람, 자연, 건물 등)|

### 9.11.4 mapping_object_topic 시트
|필드명|설명|
|---|---|
|object_id|라벨 ID|
|topic_id|주제 ID|
|w_obj|피사체 기반 가중치|
|w_scene|장면 기반 가중치|
|w_ocr|OCR 텍스트 기반 가중치|
|w_landmark|랜드마크 기반 가중치|
|penalty|페널티 값(논쟁성/민감성 등)|
|notes|특이사항 메모|

### 9.11.5 데이터북 요약 표
|구성|설명|
|---|---|
|24 주제(Topics)|신학 주제 정의·정책·번역키|
|120 라벨(Objects)|피사체 라벨·동의어|
|라벨×주제 매트릭스|가중치·보정|
|정책/노트|Allow/Attenuate/Block 규칙·메모|

### 9.11.6 파일 목록(실제 산출물)
|파일|용도|
|---|---|
|24Topics_AllInOne_v2_3_ready_final.xlsx|24 주제 정의/정책/번역키 마스터|
|성경앱_신학주제_24개_v1.csv|24 주제 경량 버전(앱·온디바이스용)|
|성경앱_피사체라벨_120개_v1.csv|120 라벨 정의(피사체·동의어 포함)|
|피사체120_라벨_주제가중치_v1.csv|120×24 매트릭스(라벨×주제가중치)|

#### 9.11.6.1 데이터 파일 인덱스(정본)
| 파일                                      | 주요 시트                                                                          | 주요 용도                           |
| --------------------------------------- | ------------------------------------------------------------------------------ | ------------------------------- |
| 1208_성경프로젝트_144개국_우선순위_vFinal.xlsx      | Raw_Original(140), Parameters(7), TierRules(4), AE_Clusters(4), PP_Clusters(4) | 144개국 우선순위 산정(원본+규칙)            |
| 24Topics_AllInOne_v2_3_ready_final.xlsx | topics_24(24), anchors_ko, anchors_en, weights, verses, import_ko, ...         | 역본/구절/주제/앵커 데이터북(통합)            |
| 피사체120_라벨_주제가중치_v1.csv                  | -                                                                              | 120 피사체 × 24 주제 가중치(정본)         |
| Bible_Object_Definition_120_v1.csv      | -                                                                              | 120 피사체 라벨 정의/동의어(정본)           |
| detection_labels_map.csv                | -                                                                              | 온디바이스 감지 라벨(모델) ↔ object_tag 매핑 |
### 9.11.7 공통 스키마 규칙
|규칙|값|
|---|---|
|인코딩|UTF-8|
|키|PK id, FK *_id|
|가중치 범위|0.00~1.00|
|날짜|YYYY-MM-DD|
|로케일|BCP 47|

### 9.11.8 CSV 스키마(경량 배포용)
|테이블|컬럼|
|---|---|
|24주제|topic_id, slug, name_ko, name_en, desc_ko, desc_en|
|120라벨|object_id, slug, name_ko, name_en, synonyms_ko[], synonyms_en[]|
|매트릭스|object_id, topic_id, w_obj, w_scene, w_ocr, w_landmark, penalty|

### 9.11.9 관계 모델 & 가중치 합성 규칙
- 관계 모델
    
    - **Topics(24) ⟷ Objects(120)**: N:M 구조이며, `mapping_object_topic` 매트릭스가 두 엔티티 사이의 가중치·보정 값을 저장합니다.
        
- 가중치 합성 규칙(내부 구현용)
    
    - `w_base = w_obj + w_scene + w_ocr + w_landmark`
        
    - `w_penalized = max(0, w_base - penalty)`
        
    - 정규화된 `w_penalized` 값들을 기반으로 주제별 사전 점수(preThemeScore)를 계산하고, 이는 9.5.3.1의 `ThemeScore(t)` 및 9.6.1의 최종 Score 식에서 **ImgRel/ThemeOrthodoxy** 성분을 구성하는 핵심 입력으로 사용됩니다.
        

#### 9.11.9.1 추천 엔진과의 연결(문맥별 주제 가중치 예시)
다음 표는 **대표적인 장면·문맥에 따라 어떤 주제 가중치가 강화되는지**를 예시로 보여 줍니다. 실제 값은 `mapping_object_topic` 매트릭스 및 컨텍스트 보정 로직에서 수치화됩니다.

|문맥|가중 주제 예|
|---|---|
|산/고도↑|경외, 도움, 인내|
|해안/항구|창조, 빛, 인도|
|도심 야간/우천|안식, 인도|
|교회/주일 오전|예배, 공동체|

---
### 9.11.10 데이터 정본 스냅샷 (24 주제/120 피사체/Top 가중치)
#### 9.11.10.1 24 주제 표준 목록
|topic_id|topic_name|
|---|---|
|1|창조·섭리|
|2|임재·영광|
|3|거룩·성화|
|4|은혜|
|5|믿음·신뢰|
|6|회개|
|7|구원·의(칭의)|
|8|소망·부활|
|9|말씀·진리|
|10|기도|
|11|예배·찬양|
|12|순종·겸손|
|13|사랑(아가페)|
|14|인내·시험|
|15|지혜·분별|
|16|성령·열매|
|17|평강·샬롬|
|18|공동체·연합|
|19|정의·공의|
|20|화해·용서(관계)|
|21|소명·일·청지기|
|22|가정·양육|
|23|치유·회복|
|24|보호·인도|

#### 9.11.10.2 120 피사체(Objects) 표준 목록
|id|대분류|라벨|별칭|
|---|---|---|---|
|1|자연/기상|산|mountain, 산맥|
|2|자연/기상|언덕||
|3|자연/기상|바다|sea, 바닷가|
|4|자연/기상|호수|lake|
|5|자연/기상|강|river|
|6|자연/기상|숲|forest|
|7|자연/기상|나무|tree|
|8|자연/기상|들판|field|
|9|자연/기상|하늘|sky|
|10|자연/기상|구름|cloud|
|11|자연/기상|비|rain|
|12|자연/기상|눈|snow|
|13|자연/기상|폭풍|storm|
|14|자연/기상|무지개|rainbow|
|15|자연/기상|태양|sun|
|16|자연/기상|달|moon|
|17|자연/기상|별|star|
|18|자연/기상|불|fire|
|19|자연/기상|물|water|
|20|자연/기상|바람|wind|
|21|도시/장소|길|road|
|22|도시/장소|다리|bridge|
|23|도시/장소|도시|city|
|24|도시/장소|건물|building|
|25|도시/장소|집|home, house|
|26|도시/장소|교회|church|
|27|도시/장소|성전|temple|
|28|도시/장소|시장|market|
|29|도시/장소|학교|school|
|30|도시/장소|병원|hospital|
|31|도시/장소|감옥|prison|
|32|도시/장소|법정|court|
|33|도시/장소|왕궁|palace|
|34|도시/장소|문|gate|
|35|도시/장소|성벽|wall|
|36|도시/장소|광장|square|
|37|도시/장소|무덤|tomb, grave|
|38|사람/신체|사람|person|
|39|사람/신체|아이|child|
|40|사람/신체|가족|family|
|41|사람/신체|군중|crowd|
|42|사람/신체|손|hand|
|43|사람/신체|발|foot|
|44|사람/신체|눈(신체)|eye|
|45|사람/신체|입|mouth|
|46|사람/신체|눈물|tear|
|47|사람/신체|무릎|knee|
|48|사람/신체|머리|head|
|49|동물|양|sheep|
|50|동물|염소|goat|
|51|동물|소|cow|
|52|동물|말|horse|
|53|동물|낙타|camel|
|54|동물|당나귀|donkey|
|55|동물|사자|lion|
|56|동물|독수리|eagle|
|57|동물|비둘기|dove|
|58|동물|물고기|fish|
|59|동물|뱀|snake|
|60|동물|개|dog|
|61|동물|새|bird|
|62|식물/음식|포도|grape|
|63|식물/음식|포도나무|vine|
|64|식물/음식|무화과|fig|
|65|식물/음식|올리브|olive|
|66|식물/음식|감람나무|olive tree|
|67|식물/음식|곡식|grain|
|68|식물/음식|빵|bread|
|69|식물/음식|포도주|wine|
|70|식물/음식|기름|oil|
|71|식물/음식|꿀|honey|
|72|식물/음식|소금|salt|
|73|식물/음식|물(음료)|drink water|
|74|종교/상징|십자가|cross|
|75|종교/상징|성경|bible|
|76|종교/상징|촛불|candle|
|77|종교/상징|향|incense|
|78|종교/상징|제단|altar|
|79|종교/상징|떡|communion bread|
|80|종교/상징|잔|cup|
|81|종교/상징|세례|baptism|
|82|종교/상징|기도하는 손|praying hands|
|83|종교/상징|하트|heart|
|84|종교/상징|면류관|crown|
|85|종교/상징|왕관|royal crown|
|86|종교/상징|검|sword|
|87|종교/상징|방패|shield|
|88|종교/상징|나팔|trumpet|
|89|종교/상징|등불|lamp|
|90|종교/상징|문(상징)|door|
|91|종교/상징|열쇠|key|
|92|생활/사물|돈|money|
|93|생활/사물|동전|coin|
|94|생활/사물|집(소유)|property|
|95|생활/사물|옷|clothes|
|96|생활/사물|신발|shoes|
|97|생활/사물|배|ship|
|98|생활/사물|그물|net|
|99|생활/사물|낚싯대|fishing rod|
|100|생활/사물|책|book|
|101|생활/사물|편지|letter|
|102|생활/사물|도장/인장|seal|
|103|생활/사물|저울|scale|
|104|생활/사물|등|light|
|105|생활/사물|창|window|
|106|생활/사물|침대|bed|
|107|생활/사물|식탁|table|
|108|생활/사물|의자|chair|
|109|생활/사물|길(여정)|journey|
|110|생활/사물|지도|map|
|111|생활/사물|배낭|bag|
|112|생활/사물|꽃|flower|
|113|생활/사물|향수/향유|perfume|
|114|생활/사물|약|medicine|
|115|생활/사물|붕대|bandage|
|116|생활/사물|문서|document|
|117|생활/사물|깃발|flag|
|118|생활/사물|피|blood|
|119|생활/사물|돌|stone|
|120|생활/사물|샘/우물|well|

#### 9.11.10.3 주제별 Top5 피사체(가중치) 스냅샷
| topic_id | topic_name | rank | object_id | object_label | w_obj |
| -------- | ---------- | ---- | --------- | ------------ | ----- |
| 1        | 창조·섭리      | 1    | 1         | 산            | 0.7   |
| 1        | 창조·섭리      | 2    | 8         | 들판           | 0.7   |
| 1        | 창조·섭리      | 3    | 2         | 언덕           | 0.7   |
| 1        | 창조·섭리      | 4    | 11        | 비            | 0.7   |
| 1        | 창조·섭리      | 5    | 10        | 구름           | 0.7   |
| 2        | 임재·영광      | 1    | 84        | 면류관          | 0.6   |
| 2        | 임재·영광      | 2    | 57        | 관            | 0.5   |
| 2        | 임재·영광      | 3    | 9         | 하늘           | 0.3   |
| 2        | 임재·영광      | 4    | 10        | 구름           | 0.3   |
| 2        | 임재·영광      | 5    | 74        | 성전           | 0.3   |
| 3        | 거룩·성화      | 1    | 26        | 교회           | 0.7   |
| 3        | 거룩·성화      | 2    | 78        | 제단           | 0.7   |
| 3        | 거룩·성화      | 3    | 74        | 성전           | 0.7   |
| 3        | 거룩·성화      | 4    | 81        | 세례           | 0.6   |
| 3        | 거룩·성화      | 5    | 75        | 성경           | 0.5   |
| 4        | 은혜         | 1    | 71        | 꿀            | 0.7   |
| 4        | 은혜         | 2    | 68        | 빵            | 0.7   |
| 4        | 은혜         | 3    | 70        | 기름           | 0.6   |
| 4        | 은혜         | 4    | 69        | 포도주          | 0.6   |
| 4        | 은혜         | 5    | 62        | 포도           | 0.5   |
| 5        | 믿음·신뢰      | 1    | 42        | 손            | 0.6   |
| 5        | 믿음·신뢰      | 2    | 48        | 머리           | 0.4   |
| 5        | 믿음·신뢰      | 3    | 82        | 기도하는 손       | 0.4   |
| 5        | 믿음·신뢰      | 4    | 74        | 성전           | 0.3   |
| 5        | 믿음·신뢰      | 5    | 26        | 교회           | 0.3   |
| 6        | 회개         | 1    |           |              |       |
| 6        | 회개         | 2    |           |              |       |
| 6        | 회개         | 3    |           |              |       |
| 6        | 회개         | 4    |           |              |       |
| 6        | 회개         | 5    |           |              |       |
| 7        | 구원·의(칭의)   | 1    | 74        | 성전           | 0.4   |
| 7        | 구원·의(칭의)   | 2    | 75        | 성경           | 0.4   |
| 7        | 구원·의(칭의)   | 3    | 81        | 세례           | 0.4   |
| 7        | 구원·의(칭의)   | 4    | 78        | 제단           | 0.3   |
| 7        | 구원·의(칭의)   | 5    | 26        | 교회           | 0.3   |
| 8        | 소망·부활      | 1    | 14        | 무지개          | 0.7   |
| 8        | 소망·부활      | 2    | 17        | 별            | 0.5   |
| 8        | 소망·부활      | 3    | 15        | 태양           | 0.5   |
| 8        | 소망·부활      | 4    | 16        | 달            | 0.4   |
| 8        | 소망·부활      | 5    | 9         | 하늘           | 0.4   |
| 9        | 말씀·진리      | 1    | 75        | 성경           | 0.7   |
| 9        | 말씀·진리      | 2    | 100       | 책            | 0.6   |
| 9        | 말씀·진리      | 3    | 116       | 문서           | 0.5   |
| 9        | 말씀·진리      | 4    | 101       | 편지           | 0.4   |
| 9        | 말씀·진리      | 5    | 88        | 나팔           | 0.3   |
| 10       | 기도         | 1    | 82        | 기도하는 손       | 0.7   |
| 10       | 기도         | 2    | 46        | 눈물           | 0.5   |
| 10       | 기도         | 3    | 47        | 무릎           | 0.5   |
| 10       | 기도         | 4    | 42        | 손            | 0.4   |
| 10       | 기도         | 5    | 26        | 교회           | 0.3   |
| 11       | 예배·찬양      | 1    | 26        | 교회           | 0.7   |
| 11       | 예배·찬양      | 2    | 88        | 나팔           | 0.6   |
| 11       | 예배·찬양      | 3    | 74        | 성전           | 0.6   |
| 11       | 예배·찬양      | 4    | 78        | 제단           | 0.5   |
| 11       | 예배·찬양      | 5    | 76        | 촛불           | 0.4   |
| 12       | 순종·겸손      | 1    | 47        | 무릎           | 0.7   |
| 12       | 순종·겸손      | 2    | 42        | 손            | 0.4   |
| 12       | 순종·겸손      | 3    | 96        | 신발           | 0.4   |
| 12       | 순종·겸손      | 4    | 95        | 옷            | 0.3   |
| 12       | 순종·겸손      | 5    | 109       | 길(여정)        | 0.3   |
| 13       | 사랑(아가페)    | 1    | 83        | 하트           | 0.7   |
| 13       | 사랑(아가페)    | 2    | 40        | 가족           | 0.6   |
| 13       | 사랑(아가페)    | 3    | 39        | 아이           | 0.5   |
| 13       | 사랑(아가페)    | 4    | 57        | 비둘기          | 0.4   |
| 13       | 사랑(아가페)    | 5    | 112       | 꽃            | 0.4   |
| 14       | 인내·시험      | 1    | 13        | 폭풍           | 0.7   |
| 14       | 인내·시험      | 2    | 12        | 눈            | 0.6   |
| 14       | 인내·시험      | 3    | 11        | 비            | 0.6   |
| 14       | 인내·시험      | 4    | 20        | 바람           | 0.5   |
| 14       | 인내·시험      | 5    | 1         | 산            | 0.4   |
| 15       | 지혜·분별      | 1    | 100       | 책            | 0.6   |
| 15       | 지혜·분별      | 2    | 75        | 성경           | 0.6   |
| 15       | 지혜·분별      | 3    | 116       | 문서           | 0.4   |
| 15       | 지혜·분별      | 4    | 103       | 저울           | 0.3   |
| 15       | 지혜·분별      | 5    | 32        | 법정           | 0.3   |
| 16       | 성령·열매      | 1    | 57        | 비둘기          | 0.7   |
| 16       | 성령·열매      | 2    | 112       | 꽃            | 0.5   |
| 16       | 성령·열매      | 3    | 62        | 포도           | 0.4   |
| 16       | 성령·열매      | 4    | 7         | 나무           | 0.4   |
| 16       | 성령·열매      | 5    | 63        | 포도나무         | 0.4   |
| 17       | 평강·샬롬      | 1    | 14        | 무지개          | 0.5   |
| 17       | 평강·샬롬      | 2    | 3         | 바다           | 0.4   |
| 17       | 평강·샬롬      | 3    | 4         | 호수           | 0.4   |
| 17       | 평강·샬롬      | 4    | 57        | 비둘기          | 0.4   |
| 17       | 평강·샬롬      | 5    | 9         | 하늘           | 0.3   |
| 18       | 공동체·연합     | 1    | 41        | 군중           | 0.6   |
| 18       | 공동체·연합     | 2    | 40        | 가족           | 0.6   |
| 18       | 공동체·연합     | 3    | 26        | 교회           | 0.5   |
| 18       | 공동체·연합     | 4    | 79        | 떡            | 0.4   |
| 18       | 공동체·연합     | 5    | 80        | 잔            | 0.4   |
| 19       | 정의·공의      | 1    | 32        | 법정           | 0.6   |
| 19       | 정의·공의      | 2    | 103       | 저울           | 0.6   |
| 19       | 정의·공의      | 3    | 110       | 지도           | 0.3   |
| 19       | 정의·공의      | 4    | 31        | 감옥           | 0.3   |
| 19       | 정의·공의      | 5    | 72        | 소금           | 0.3   |
| 20       | 화해·용서(관계)  | 1    | 83        | 하트           | 0.4   |
| 20       | 화해·용서(관계)  | 2    | 40        | 가족           | 0.4   |
| 20       | 화해·용서(관계)  | 3    | 46        | 눈물           | 0.3   |
| 20       | 화해·용서(관계)  | 4    | 42        | 손            | 0.3   |
| 20       | 화해·용서(관계)  | 5    | 57        | 비둘기          | 0.3   |
| 21       | 소명·일·청지기   | 1    | 21        | 길            | 0.4   |
| 21       | 소명·일·청지기   | 2    | 67        | 곡식           | 0.4   |
| 21       | 소명·일·청지기   | 3    | 98        | 그물           | 0.4   |
| 21       | 소명·일·청지기   | 4    | 99        | 낚싯대          | 0.4   |
| 21       | 소명·일·청지기   | 5    | 109       | 길(여정)        | 0.3   |
| 22       | 가정·양육      | 1    | 40        | 가족           | 0.7   |
| 22       | 가정·양육      | 2    | 39        | 아이           | 0.7   |
| 22       | 가정·양육      | 3    | 25        | 집            | 0.5   |
| 22       | 가정·양육      | 4    | 107       | 식탁           | 0.3   |
| 22       | 가정·양육      | 5    | 106       | 침대           | 0.3   |
| 23       | 치유·회복      | 1    | 114       | 약            | 0.7   |
| 23       | 치유·회복      | 2    | 115       | 붕대           | 0.6   |
| 23       | 치유·회복      | 3    | 30        | 병원           | 0.5   |
| 23       | 치유·회복      | 4    | 46        | 눈물           | 0.4   |
| 23       | 치유·회복      | 5    | 71        | 꿀            | 0.3   |
| 24       | 보호·인도      | 1    | 87        | 방패           | 0.7   |
| 24       | 보호·인도      | 2    | 91        | 열쇠           | 0.4   |
| 24       | 보호·인도      | 3    | 90        | 문(상징)        | 0.4   |
| 24       | 보호·인도      | 4    | 22        | 다리           | 0.3   |
| 24       | 보호·인도      | 5    | 109       | 길(여정)        | 0.3   |
### 9.11.11 개발 인덱싱/목록화 (P1·P2·P3 코드 정책)
이 절은 P1(상징), P2(주제), P3/S(컨텍스트) 단계에서 사용하는 **코드 네이밍 규칙과 로그 형태**를 통일하기 위한 개발자용 인덱싱 규약을 정의합니다. 동일한 규칙을 사용하면, 데이터북·로그·대시보드·API 응답을 한눈에 추적하기 쉬워집니다.

|No.|체계|규칙|
|--:|---|---|
|1|상징 코드|`SYM-도메인코드+번호` (예: `SYM-A07` 해·빛)|
|2|주제 코드|`THEME-XX` (12대분류 고정, 하위분류 확장)|
|3|컨텍스트|`CTX-time/scene/poi/visual` 키|
|4|버전|스키마/룰 `vX.Y` (호환성: optional 추가만 허용)|
|5|로그|`[{symbol_id, conf, weight, source}]` 스냅샷|

**설명**

- **상징 코드(SYM-*)**: 상징 도메인(예: A=천체/빛, B=자연, C=도시…) + 2자리 번호 형식으로 관리하여, 120라벨 확장 시에도 정렬·그룹핑이 쉽도록 합니다.
    
- **주제 코드(THEME-XX)**: 상위 12대 분류(예: 위로, 소망, 창조, 죄·용서 등)에 고정 코드를 부여하고, 필요 시 하위 분류는 메타필드로 확장합니다. 이렇게 하면 상·하위 주제를 혼동하지 않고 통계/대시보드에서 상위 축을 안정적으로 유지할 수 있습니다.
    
- **컨텍스트 키(CTX-*)**: 시간대(`CTX-time`), 장면(`CTX-scene`), 장소·POI(`CTX-poi`), 시각적 특징(`CTX-visual`)처럼 **역할 기준 네이밍**을 강제하여, 로그/피쳐 추출 코드가 서로 다른 이름을 쓰지 않도록 합니다.
    
- **버전(vX.Y)**: P1/P2/P3 스키마·룰 버전은 `vX.Y` 형식으로 관리하고, 뒤로 갈수록 **호환성 유지(필드 optional 추가만 허용)**를 원칙으로 합니다. 필드 삭제/이름 변경은 새로운 메이저 버전에서만 허용합니다.
    
- **로그 스냅샷**: `[{symbol_id, conf, weight, source}]` 형태로, 상징별 **탐지 신뢰도(conf)**, **가중치(weight)**, **출처(source: obj/scene/ocr/landmark 등)**를 함께 남겨두면, 나중에 왜 특정 ThemeScore가 나왔는지 역추적이 용이합니다.
    

이 규약은 9.4(엔티티 스키마), 9.6(점수식·Top-1 규칙), 9.7(데이터북 구조)와 연결되어, 전체 시스템이 **동일한 코드 체계**로 동작하도록 하는 최소 기준입니다.

## 9.12 ETL & 버전 관리
### 9.12.1 ETL 파이프라인
1. **Draft 수집**: 신학팀·데이터팀이 초안 작성
    
2. **Validate**: 스키마 검증, 중복/누락 체크
    
3. **Freeze**: 릴리즈용 버전으로 동결
    
4. **Export**: JSON/CSV/오프라인팩 포맷 생성
    
5. **Deploy**: 서버·온디바이스용 배포
    
6. **Audit**: 해시/샘플링으로 회귀 테스트
    

### 9.12.2 버전 규칙
- 형식: **v2.3.x** (메이저.마이너.패치)
    
- 원칙
    
    - **id**는 삭제하지 않고 `deprecated=true` 플래그로 처리
        
    - 버전별 변경 로그에 **Top 20 주요 변경 사항** 요약
        
    - 모델·데이터 버전 연동
        
        - 예: `model_version = "m2.3.1"`, `data_version = "d2.3.4"`
            

### 9.12.3 데이터 운영 체크리스트 — 매트릭스/룰셋 변경 시(정본)
|No|단계|규칙|완료 조건(DoD)|
|--:|---|---|---|
|1|변경 범위 고정|변경 대상(라벨/주제/가중치/페널티)을 명확히 고정|변경 목록 1페이지로 확정|
|2|모드 선택|`Edit / Safe / Freeze` 중 선택|현재 작업 상태가 모드로 표현됨|
|3|Copy 매핑|기준 키(예: `object_id-theme_id`)로 Copy|행/열 뒤틀림 없이 복사됨|
|4|기본값 처리|누락 셀은 `0.00`으로 채움|빈칸/NaN 없음|
|5|Validate 실행|범위/형식/누락/이상치 검증|Validate 로그 OK|
|6|Freeze(버전 고정)|`ruleset_version` + 데이터 버전 태깅|재현 가능(rollback 가능)|
|7|Export|CSV/JSON Export 후 배포 경로에 반영|아티팩트 생성 완료|
|8|스모크 테스트|대표 사진 셋으로 추천 결과 점검|반복/unknown/민감 오탐 지표 확인|

---

## 9.13 모델 품질 & 성능 기준
### 9.13.1 데이터셋 구조
- 학습/검증/테스트 분리
    
    - Train: 80%
        
    - Validation: 10%
        
    - Test: 10%
        
- 각 샘플 구성
    
    - 사진(또는 태그)
        
    - 컨텍스트(시간, 장소, 디바이스 언어 등)
        
    - 정답 구절
        
    - 정답 주제
        
    - 평가 라벨(적합/부적합 등)
        
- 데이터 출처
    
    - **Bible 앱**:  
        PhotoEvent, PerceptionResult, EmotionVector, RecommendationResult 로그에서 익명화·샘플링
        
    - **Soul Chorus Game**:  
        감정 라벨이 붙은 사진·세션 데이터를 익명화하여 보조 학습 데이터로 사용
        
    - 정기적인 ETL 배치로 두 소스 데이터를 병합해  
        학습/검증/테스트 세트를 재구성
        

### 9.13.2 품질 지표
|항목|목표 값(예시)|
|---|---|
|Top-1 구절 적합도(사람 평가 기준)|≥ 75%|
|Top-2(Top-1+ALT-1) 적합도|≥ 85%|
|민감 장면 리콜(아동/병원/장례 등)|≥ 90%|
|주제 분류 F1-score|≥ 0.82|

### 9.13.3 성능(지연 시간) 기준
- 전체 앱 기준 **p95 < 800ms** 중,  
    그 안에서 **AI 파이프라인이 차지하는 목표 지연 시간**:
    
    - 지각 레이어: ≤ 150ms
        
    - 벡터 검색: ≤ 80ms
        
    - 재랭커: ≤ 150ms
        
    - 가이드라인/설명: ≤ 50ms
        

### 9.13.4 차별화 포인트(품질·안전 관점 요약)
|포인트|효과|
|---|---|
|감정 사전 입력 없음|사용자가 감정을 직접 선택하지 않아도 사진·표정·상황에서 힌트를 추출해 마찰을 최소화|
|설명 가능성(Why 카드)|Why-score와 설명 카드를 통해 추천 근거를 문장과 수치로 제시, 신뢰와 수용성을 높임|
|교리 일관성(가이드라인 엔진)|예장통합 규칙에 맞지 않는 본문을 차단·감쇠해 신학적 안전을 확보|
|오프라인 팩|저연결·선교 환경에서도 대표 구절·기본 추천 기능을 유지해, 네트워크 불안정 상황에도 안정적으로 동작|
|멀티모달 입력(사진·텍스트·장소·시간)|사진·텍스트·장소·시간 등 여러 신호를 함께 사용해 다양한 상황에서도 보다 정교한 추천이 가능|
|Why-score 로깅|추천 근거를 장기적으로 기록하여, 모델 개선·품질 리뷰·감사에 활용할 수 있는 데이터 자산을 축적하는 기반이 됨|

---

### 9.11.3 동기화 전략

- 온라인 복귀 시
    
    - 오프라인에서 생성된 **PhotoEvent / PostAffection**를 **배치 업로드**
        
    - 로컬 캐시와 서버 상태를 병합
        

---

## 9.14 확장성(다국어·신규 라벨·신규 프로젝트)
### 9.14.1 다국어 확장
- 성경 번역 추가 시
    
    - Verse 테이블에 `text_xx` 컬럼 추가(예: `text_es`)
        
    - 해당 언어 임베딩 벡터 재생성
        
- UI/설명 카드
    
    - **I18N** 키 기반 번역
        
    - Why 카드도 다국어 템플릿 구조로 설계
        

### 9.14.2 신규 라벨·주제 추가
- 신규 라벨(object) 생성
    
    - objects 시트에 추가
        
    - mapping_object_topic 시트에서 가중치 정의
        
- 신규 주제(topic) 생성
    
    - topics 시트에 추가
        
    - 기존 라벨과의 매트릭스 갱신
        
    - 모델 재학습 및 회귀 테스트 필수
        

### 9.14.3 다른 프로젝트와의 연동
- 예: **Soul Chorus** 등 사진·감정 기반 서비스와 연동할 때
    
    - 공통 엔티티: PhotoEvent, PostAffection 재사용
        
    - EmotionVector를 공통 감정 표현으로 사용하여, Game에서 수집한 감정 라벨 데이터를 Bible 추천 모델(주제 분류·재랭커·Why-score)에 재학습 데이터로 활용
        
    - EmotionScriptureMap을 기반으로, Game에서 발생한 감정·상황 조합 로그를 분석해 새로운 감정-구절 매핑을 주기적으로 발견·갱신
        
    - 주제/라벨/매핑은 동일 데이터북 사용
        
    - 별도의 서비스에서는 **Verse 추천만 비활성화**하고 사진/감정만 쓰는 모드도 가능
        

---

## 9.15 용어 인덱스(기술 용어 정리)
|용어|설명|
|---|---|
|**AI**|사진·텍스트·컨텍스트를 분석하고 구절을 추천하는 인공지능 전체 기술.|
|**파이프라인**|입력부터 출력까지 여러 단계를 직렬로 연결한 처리 흐름.|
|**모듈**|특정 기능을 담당하는 독립적인 구성 요소(지각 모듈, 재랭커 모듈 등).|
|**엔티티(Entity)**|데이터베이스에서 관리하는 주요 객체 유형(PhotoEvent, Verse 등).|
|**데이터 스키마**|각 엔티티의 필드 구조와 타입을 정의한 설계.|
|**벡터 검색(Vector Search)**|임베딩 벡터 간 유사도를 계산해 가까운 항목을 찾는 검색 방식.|
|**임베딩(Embedding)**|텍스트/이미지 등의 의미를 수치 벡터로 표현한 것.|
|**라벨(Label)**|인식된 피사체/장면/텍스트 등 분류 이름(예: 산, 병원, 교회).|
|**주제(Topic)**|성경적 의미를 묶어 놓은 24개 핵심 주제(위로, 소망 등).|
|**매핑 매트릭스(Matrix)**|라벨과 주제 사이의 가중치 관계를 표로 정리한 것.|
|**ETL**|Extract-Transform-Load. 데이터 추출·변환·적재 과정.|
|**오프라인팩(Offline Pack)**|인터넷이 없어도 동작하도록 로컬에 저장한 대표 구절·임베딩 묶음.|
|**온디바이스(On-device)**|서버가 아닌 사용자 기기(스마트폰) 안에서 실행되는 연산.|
|**재랭커(Re-ranker)**|1차 후보를 다시 평가해 순서를 정교하게 조정하는 모델/로직.|
|**가이드라인 엔진**|교리·민감도 규칙을 적용해 추천 결과를 차단/감쇠/허용하는 로직.|
|**Why-score**|"왜 이 구절인가"를 설명하기 위해 남기는 근거 점수/정보 집합.|
|**F1-score**|분류 모델의 성능을 나타내는 지표(정밀도와 재현율의 조화 평균).|
|**GeoPin**|사진·구절을 지도에 표현할 때 사용하는 지리 정보 엔티티로, 실제 좌표 대신 퍼징된 지오해시·좌표와 민감도 플래그를 포함합니다.|
|**time_bucket**|하루를 아침/낮/저녁 등 시간 구간으로 나눈 필드로, 추천 로직·통계에서 시간대별 패턴 분석에 사용됩니다.|
|**pHash**|이미지의 시각적 특징을 고정 길이 해시값으로 표현해, 해시 간 거리를 통해 유사한 이미지를 빠르게 찾는 기법입니다.|
|**Signal**|점수 축(S1~S4) 하나를 구성하는 신호로, 앵커(키워드) 히트와 가중치로 계산됩니다.|
|**score_total**|S1~S4의 **가중합**으로 만든 정규화 이전의 기본 점수입니다.|
|**priority_score**|**score_total + bonus**를 **normalize_divisor**로 나눈 최종 우선순위 점수입니다.|
|**weights**|S1~S4 비율형 가중치(**w1~w4**)를 보관하는 시트(탭)입니다.|
|**priority_rules**|보너스/정규화 파라미터(**bonus_anchor**, **normalize_divisor** 등)를 보관하는 시트(탭)입니다.|
|**bonus_anchor**|S1 히트가 발생했을 때 적용되는 앵커 기반 가산점입니다.|
|**bonus_gospel**|복음서 보너스 파라미터(현 버전 v9.1 v1.1에서는 **선언만 존재**, 코드 **미적용**)|
|**bonus_wcf**|추가 보너스 파라미터(현 버전에서는 **선언만 존재**, 코드 **미적용**)입니다.|
|**normalize_divisor**|priority_score 계산에서 나누는 정규화 분모입니다.|
|**secondary_ratio**|보조 후보 제어 파라미터(현 버전 v9.1 v1.1에서는 **선언만 존재**, 코드 **미사용**)|
|**primary_margin**|Top1 확정 마진 파라미터(현 버전 v9.1 v1.1에서는 **선언만 존재**, 코드 **미사용**)|
|**쿨다운(cooldown)**|특정 구절·이벤트가 노출된 이후, 같은 항목이 다시 노출되기까지의 최소 대기 기간을 의미하며, 반복 노출과 피로도를 줄이기 위해 사용하는 로직입니다.|
